<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<style>
    .video{
        height:300px;
        width:400px;
    }
    #photo{
        height:300px;
        width:400px;
    }
</style>
<!--<video id="local" autoplay></video>
<video id="remote" autoplay></video>

<script>
    const alice = new RTCPeerConnection();
    const bob = new RTCPeerConnection();

    alice.onicecandidate = e => {
        if(e.candidate) {
            bob.addIceCandidate(e.candidate);
        }
    }

    bob.onicecandidate = e => {
        if(e.candidate) {
            alice.addIceCandidate(e.candidate);
        }
    }

    navigator.mediaDevices.getUserMedia({
    video: true,audio:true
    })
    .then(stream=>{
    document.getElementById("local").srcObject=stream;
    alice.addStream(stream);
    return alice.createOffer();
    })
    .then(offer => alice.setLocalDescription(new RTCSessionDescription(offer)))
    .then(() => bob.setRemoteDescription(alice.localDescription))
    .then(() => bob.createAnswer())
    .then(answer => bob.setLocalDescription(new RTCSessionDescription(answer)))
    .then(() => alice.setRemoteDescription(bob.localDescription));

    bob.ontrack = e => {
    document.getElementById("remote").srcObject = e.streams[0];
    }

</script>-->

<!-- Title & header of demo aplication. -->
<body>
    <h3 id="show-peer"></h3>
    <div style="display: flex; justify-content:space-around; margin:10px;">
        <div style="width: 400px; height:300px; border: 2px solid;" id="ourVideo">Our video</div>
        <div style="width: 400px; height:300px; border: 2px solid;" id="remoteVideo">Remote video</div>
        <br>
        <div style="width: 400px; height:300px; border: 2px solid;" id="photo">Client photo</div>
    </div>
    <input id="peerID" placeholder="Peer ID">
    <button id="call-peer">Call Peer</button>
    <br>
    <button id="shot">Take a photo of the client</button>

</body>

<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<script>
    window.addEventListener('load',(event)=>{
        var peer = new Peer()
        var myStream;
        var peerList =[];
        peer.on('open',function(id){
            document.getElementById("show-peer").innerHTML = id
        })
        peer.on('call', function(call){

                navigator.mediaDevices.getUserMedia({
                    video:true,
                    audio:true
                }).then((stream)=>{
                    myStream = stream

                    call.answer(stream)
                    call.on('stream',function(remoteStream){
                    if(peerList.length == 0){
                        addRemoteVideo(remoteStream)
                        addOurVideo(stream)
                        peerList.push(call.peer)
                    }
                    })
                }).catch((err)=>{
                    console.log(err+" unable to get media")
                })

        })

        document.getElementById("call-peer").addEventListener('click',(e)=>{
            let remotePeerId = document.getElementById("peerID").value;
            document.getElementById("show-peer").innerHTML = "connecting "+remotePeerId;
            callPeer(remotePeerId);
        })

        document.getElementById("shot").addEventListener('click',(e)=>{
            const video = document.getElementById("video");
            const canvas = document.createElement("canvas");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            canvas.getContext('2d')
              .drawImage(video, 0, 0, 400, 300);

            const dataURL = canvas.toDataURL();

            var img = document.createElement("img");
            img.src = dataURL;
            document.getElementById("photo").append(img);
        })

        function callPeer(id){
            navigator.mediaDevices.getUserMedia({
                video:true,
                audio:true
            }).then((stream)=>{
                myStream = stream

                let call = peer.call(id, stream)
                call.on('stream', function(remoteStream){
                    if(peerList.length == 0){
                        addRemoteVideo(remoteStream)
                        addOurVideo(stream)
                        peerList.push(call.peer)
                    }
                })
            }).catch((err)=>{
                console.log(err+" unable to get media")
            })
        }

        function addRemoteVideo(stream){
            let video = document.createElement("video");
            video.classList.add("video")
            video.setAttribute("id", "video");
            video.srcObject=stream;
            video.play()
            document.getElementById("remoteVideo").append(video);
        }

        function addOurVideo(stream){
            let video = document.createElement("video");
            video.classList.add("video")
            video.srcObject=stream;
            video.play()
            document.getElementById("ourVideo").append(video);
        }
    });
</script>


</html>