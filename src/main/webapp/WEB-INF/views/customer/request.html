<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<style>
    .video {
      height: 100%;
      width: 100%;
    #photo{
        height:300px;
        width:400px;
    }
</style>

<body th:object="${request}">

<h1 th:text="${'Запрос №'+request.getId()}">id</h1>
<div th:if="${request.getRequestStatus()==T(kkv.spring.models.RequestStatus).PENDING}">
    <h3 id="show-peer"></h3>
    <div  style=" display: inline-block; justify-content:space-around; margin:10px; margin-bottom:30px;">

        <div style="
            min-height:720px;
            min-width:1080px;
            width: auto;
             height:auto;
              border: 2px solid;
               margin:350px;
               margin-top:10px;
               margin-bottom:50px;
        " id="remoteVideo">Remote video
            <div style="width: 250px;position: relative;display: display:inline;float:ight; height:180px; border: 2px solid; margin-right:20px; margin-left:auto; margin-top:20px;" id="ourVideo">Our video</div>
        </div>

    </div>

    <input id="peerID" placeholder="Peer ID" name="id">
    <button id="call-peer">Call Peer</button>

    <div th:if="${isEmployee}">

        <div style="display: inline-block;float:left; margin-left:auto; margin-right:50px; width: 400px; height:300px; border: 2px solid;" id="photo">
            Client photo
            <img id="personPhotoImg">
        </div>

        <div style="display: inline-block;float:left;margin-left:50px; margin-right:auto; width: 400px; height:300px; border: 2px solid;" >
            Passport photo
            <img th:src="@{/images/{id}/{name} (id=${request.getId()},name=${request.getLocationFirstPassportSpread()})}"
                 alt="image" height="300px" width="400px" id="passportPhotoCompare"
            />
        </div>
        <div style="display: inline-block; width: 400px; height:300px;margin:20px;padding:10px;">
            <div  style="display:block;">
                <button id="shot">Сфотографировать клиента</button>
            </div>
            <div style="display:block;">
                <form  enctype="multipart/form-data">
                    <table>
                        <tr><td></td><td><input id="searchButton" type="submit" value="Сравнить изображения" /></td></tr>
                    </table>
                </form>
            </div>
        </div>

        <span id="eventCount"> </span>
    </div>



</div>


<div style= "display:inline;float:left;">
    <img th:src="@{/images/{id}/{name} (id=${request.getId()},name=${request.getLocationFirstPassportSpread()})}"
         alt="image" height="300px" width="400px"/>
    <br>
    <p>Первый разворот паспорта с фотографией</p>
</div>
<div style= "display:inline;float:left;">
    <img th:src="@{/images/{id}/{name} (id=${request.getId()},name=${request.getLocationResidencePermitPassportSpread()})}"
         alt="image" height="300px" width="400px"
    />
    <br>
    <p>Страница паспорта с пропиской</p>
</div>


<div th:if="${isEmployee}" th:switch="${request.getRequestStatus()}">

    <a th:href="@{/users/{login}/inf (login = ${request.getUserAccount().getLogin()})}">Отправитель</a>

    <div th:case="${T(kkv.spring.models.RequestStatus).PENDING}">
        <form th:method="POST" th:action="@{/requests/{id}/approve (id=${request.getId()})}">
            <input type="submit" value="Подтвердить"/>
        </form>

        <form th:method="POST" th:action="@{/requests/{id}/reject (id=${request.getId()})}">
            <input type="submit" value="Отклонить"/>
        </form>
    </div>

    <div th:case="${T(kkv.spring.models.RequestStatus).APPROVED}">
        <h1>Вы одобрили заявку</h1>
    </div>
    <div th:case="${T(kkv.spring.models.RequestStatus).REJECTED}">
        <h1>Вы отклонили заявку</h1>
    </div>

</div>

<div th:if="${!isEmployee}" th:switch="${request.getRequestStatus()}">
    <div th:case="${T(kkv.spring.models.RequestStatus).PENDING}">
        <h1>Ваша заявка находится на рассмотрении</h1>
        <br>
        <form th:method="POST" th:action="@{/requests/{id}/cancel (id=${request.getId()})}" th:object="${account}">
            <input type="submit" value="Отменить заявку"/>
        </form>
    </div>
    <div th:case="${T(kkv.spring.models.RequestStatus).APPROVED}">
        <h1>Ваша личность подтверждена</h1>
    </div>
    <div th:case="${T(kkv.spring.models.RequestStatus).REJECTED}">
        <h1>Ваша личность отклонена</h1>
    </div>
</div>
<br>
</body>

<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script>

    var personPhoto = '';

    $(document).ready(function () {

        $("#searchButton").click(function (event) {

            //stop submit the form, we will post it manually.
            event.preventDefault();
            fire_ajax_submit();

        });

    });

    function fire_ajax_submit() {

        var data = new FormData();


        data.append("personPhoto", personPhoto);
        data.append("passportPhoto", document.getElementById("passportPhotoCompare").src);

        if (document.getElementById("eventCount"))
            document.getElementById("eventCount").textContent="Фотографии обрабатываются, пожалуйста подождите";
        else if (document.getElementById("reload"))
            document.getElementById("reload").textContent="Фотографии обрабатываются, пожалуйста подождите";

        $.ajax({
            type: "POST",
            enctype: 'multipart/form-data',
            url: "/compare_photos",
            data: data,
            //http://api.jquery.com/jQuery.ajax/
            //https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects
            processData: false, //prevent jQuery from automatically transforming the data into a query string
            contentType: false,
            cache: false,
            timeout: 600000,
            success: function (data) {
                $("#eventCount").replaceWith(data);
                $("#reload").replaceWith(data);
            },
            error: function (e) {
                $("#eventCount").replaceWith(e);
            }
        });

    }

    window.addEventListener('load',(event)=>{
        var peer = new Peer()
        var myStream;
        var peerList =[];
        peer.on('open',function(id){
            document.getElementById("show-peer").innerHTML = id
        })
        peer.on('call', function(call){

                navigator.mediaDevices.getUserMedia({
                    video:true,
                    audio:true
                }).then((stream)=>{
                    myStream = stream

                    call.answer(stream)
                    call.on('stream',function(remoteStream){
                    if(peerList.length == 0){
                        addRemoteVideo(remoteStream)
                        addOurVideo(stream)
                        peerList.push(call.peer)
                    }
                    })
                }).catch((err)=>{
                    console.log(err+" unable to get media")
                })

        })

        document.getElementById("call-peer").addEventListener('click',(e)=>{
            let remotePeerId = document.getElementById("peerID").value;
            document.getElementById("show-peer").innerHTML = "connecting "+remotePeerId;
            callPeer(remotePeerId);
        })

        document.getElementById("shot").addEventListener('click',(e)=>{
            const video = document.getElementById("video");
            const canvas = document.createElement("canvas");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            canvas.getContext('2d')
              .drawImage(video, 0, 0, 400, 300);

            const dataURL = canvas.toDataURL("image/png");

            personPhoto = dataURL;

            document.getElementById("personPhotoImg").src=dataURL;
        })

        function callPeer(id){
            navigator.mediaDevices.getUserMedia({
                video:true,
                audio:true
            }).then((stream)=>{
                myStream = stream

                let call = peer.call(id, stream)
                call.on('stream', function(remoteStream){
                    if(peerList.length == 0){
                        addRemoteVideo(remoteStream)
                        addOurVideo(stream)
                        peerList.push(call.peer)
                    }
                })
            }).catch((err)=>{
                console.log(err+" unable to get media")
            })
        }

        function addRemoteVideo(stream){
            let video = document.createElement("video");
            video.classList.add("video")
            video.setAttribute("id", "video");
            video.srcObject=stream;
            video.play()
            document.getElementById("remoteVideo").append(video);
        }

        function addOurVideo(stream){
            let video = document.createElement("video");
            video.classList.add("video")
            video.srcObject=stream;
            video.play()
            document.getElementById("ourVideo").append(video);
        }
    });
</script>
<<<<<<< Updated upstream

=======
>>>>>>> Stashed changes
</html>